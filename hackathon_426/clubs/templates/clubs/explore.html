{% load static %}
<link rel="stylesheet" href="{% static 'clubs/explore.css' %}">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">

<!-- Navigation Bar -->
<ul class="nav-bar">
  <a href=""><img class="nav-bar-img" src="{% static 'clubs/images/logo.png' %}" alt="CAPY Technologies Logo"></a>
  <div class="nav-links">
    <a class="nav-link {% if request.resolver_match.url_name == 'clubs_home' %}active{% endif %}" 
       href="{% url 'clubs_home' %}">Home</a>
    <a class="nav-link {% if request.resolver_match.url_name == 'explore' %}active{% endif %}" 
       href="{% url 'explore' %}">Explore</a>
    <a class="nav-link {% if request.resolver_match.url_name == 'cart' %}active{% endif %}" 
       href="{% url 'cart' %}">Cart</a>
    <a class="logout" href="{% url 'logout' %}">
        <i class="fas fa-lock"></i>Logout
    </a>
  </div>
</ul>

<section class="card-container">
  {% for club in clubs %}
    <div class="club-card" data-club-id="{{ club.id }}" {% if not forloop.first %}style="display:none;"{% endif %}>
      <h2 class="explore-title">{{ club.name }} </h2>
      {% if club.banner %}
        <img class="club-banner" src="{{ club.banner.url }}" alt="Banner">
      {% endif %}
      <div class="club-info">
        {% if club.logo %}
          <img class="club-logo" src="{{ club.logo.url }}" alt="Logo">
        {% endif %}
        <div class="club-text">
          <p><strong>Description:</strong> {{ club.description }}</p>
          <p><strong>Meeting Time:</strong> {{ club.meeting_time }}</p>
        </div>
      </div>
    </div>
  {% endfor %}
</section>

<section class="explore-container">
  <p class="swipe-tip">Use your arrow keys: ‚Üê to dislike, ‚Üí to like</p>
  <form method="post" action="{% url 'reset_swipes' %}" class="reset-form">
    {% csrf_token %}
    <button type="submit" class="reset-btn">Reset My Swipes</button>
  </form>
</section>
  
<script>
  const cards = document.querySelectorAll('.club-card');
  let current = 0;
  let isSwiping = false; 

  document.addEventListener('keydown', function(event) {
    if (isSwiping) return; // Prevent multiple swipes at once
    if (event.key === "ArrowRight") {
      swipe('like');
    } else if (event.key === "ArrowLeft") {
      swipe('dislike');
    }
  });

  async function swipe(action) {
    const card = cards[current];
    if (!card) return;

    const clubId = card.dataset.clubId;
    isSwiping = true; // Prevent multiple swipes

    // Add animation class
    if (action === 'like') {
      card.classList.add('swipe-right');
    } else if (action === 'dislike') {
      card.classList.add('swipe-left');
    }

    // Wait for animation to complete before hiding and showing next
    setTimeout(() => {
      card.style.display = 'none';
      card.classList.remove('swipe-left', 'swipe-right');

      current++;

      if (current < cards.length) {
        cards[current].style.display = 'block';
      } else {
        alert("üéâ You've reached the end!");
      }
      isSwiping = false; // Allow next swipe
    }, 500); // Match your CSS transition time

    // Send swipe to backend
    try {
      await fetch(`/clubs/swipe/${clubId}/${action}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        },
      });
    } catch (err) {
      console.error("Swipe failed:", err);
    }
  }

  // CSRF helper function
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>

