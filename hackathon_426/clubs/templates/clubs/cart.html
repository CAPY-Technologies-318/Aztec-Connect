{% load static %}
<link rel="stylesheet" href="{% static 'clubs/cart.css' %}">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
<h2 class="cart-title">My Clubs</h2>

<!-- Navigation Bar -->
<ul class="nav-bar">
  <a href=""><img class="nav-bar-img" src="{% static 'clubs/images/logo.png' %}" alt="CAPY Technologies Logo"></a>
  <div class="nav-links">
    <a class="nav-link {% if request.resolver_match.url_name == 'clubs_home' %}active{% endif %}" 
       href="{% url 'clubs_home' %}">Home</a>
    <a class="nav-link {% if request.resolver_match.url_name == 'explore' %}active{% endif %}" 
       href="{% url 'explore' %}">Explore</a>
    <a class="nav-link {% if request.resolver_match.url_name == 'cart' %}active{% endif %}" 
       href="{% url 'cart' %}">Cart</a>
    <a class="nav-link {% if request.resolver_match.url_name == 'user_profile' %}active{% endif %}"
        href="{% url 'user_profile' %}">Profile</a>
    <a class="logout" href="{% url 'logout' %}">
        <i class="fas fa-lock"></i>Logout
    </a>
  </div>
</ul>

<div class="cart-container">
  {% if cart %}
    <div class="cart-actions-header">
      <label class="select-all-container">
        <input type="checkbox" id="select-all" onchange="toggleAllClubs()">
        <span>Select All</span>
      </label>
      <button id="join-selected" class="join-selected-btn" onclick="joinSelectedClubs()" disabled>
        Join Selected Clubs
      </button>
    </div>
  {% endif %}
  
  {% for interaction in cart %}
    <div class="club-item" id="club-item-{{ interaction.club.id }}">
      <div class="club-select">
        <input type="checkbox" class="club-checkbox" data-club-id="{{ interaction.club.id }}" onchange="updateJoinButton()">
      </div>
      {% if interaction.club.logo %}
        <img class="club-logo" src="{{ interaction.club.logo.url }}" alt="{{ interaction.club.name }} Logo">
      {% endif %}
      <div class="club-info">
        <h3>{{ interaction.club.name }}</h3>
        <div class="cart-actions">
          <a class="cart-btn details" href="{% url 'club_detail' interaction.club.id %}">View Details</a>
        </div>
      </div>
    </div>
  {% empty %}
    <p class="empty-cart">No clubs in cart.</p>
  {% endfor %}
</div>

<style>
@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

.cart-actions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding: 0 1rem;
}

.select-all-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: white;
    cursor: pointer;
}

.select-all-container input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.join-selected-btn {
    background-color: rgb(223, 201, 203);
    color: black;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.join-selected-btn:hover:not(:disabled) {
    background-color: rgb(207, 174, 177);
}

.join-selected-btn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

.club-select {
    display: flex;
    align-items: center;
    padding: 0 1rem;
}

.club-select input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.club-item {
    display: flex;
    align-items: center;
}
</style>

<script>
function updateJoinButton() {
    const checkboxes = document.querySelectorAll('.club-checkbox:checked');
    const joinButton = document.getElementById('join-selected');
    joinButton.disabled = checkboxes.length === 0;
    
    // Update select all checkbox
    const allCheckboxes = document.querySelectorAll('.club-checkbox');
    const selectAllCheckbox = document.getElementById('select-all');
    selectAllCheckbox.checked = checkboxes.length === allCheckboxes.length;
}

function toggleAllClubs() {
    const selectAllCheckbox = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.club-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    updateJoinButton();
}

function joinSelectedClubs() {
    const selectedClubs = Array.from(document.querySelectorAll('.club-checkbox:checked'))
        .map(checkbox => checkbox.dataset.clubId);
    
    if (selectedClubs.length === 0) return;
    
    const joinPromises = selectedClubs.map(clubId =>
        fetch(`/clubs/join/${clubId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
    );
    
    Promise.all(joinPromises)
        .then(() => {
            // Remove joined clubs with animation
            selectedClubs.forEach(clubId => {
                const clubItem = document.getElementById(`club-item-${clubId}`);
                clubItem.style.animation = 'fadeOut 0.5s';
                setTimeout(() => {
                    clubItem.remove();
                    // Check if cart is empty
                    if (document.querySelectorAll('.club-item').length === 0) {
                        document.querySelector('.cart-container').innerHTML = '<p class="empty-cart">No clubs in cart.</p>';
                    }
                }, 500);
            });
        })
        .catch(error => console.error('Error:', error));
}
</script>
